ğŸ”§ GUÃA DE DEPURACIÃ“N - FACTURAS NO FUNCIONAN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROBLEMA ORIGINAL:
âŒ Descargar factura no funciona
âŒ Ver factura no funciona
âŒ Se redirige automÃ¡ticamente a inicio

CAUSAS IDENTIFICADAS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. âŒ RUTAS NO REGISTRADAS EN ROUTER
   â€¢ Las rutas /factura/ver, /factura/descargar no estaban en Public/index.php
   â€¢ El sistema usa switch() manual, no un router automÃ¡tico
   â€¢ Agregadas ANTES del 'default' case

2. âŒ VARIABLES DE SESIÃ“N INCORRECTAS
   â€¢ Usaba $_SESSION['user_rol'] 
   â€¢ DeberÃ­a ser $_SESSION['user_role']
   â€¢ Corregido en InvoiceController

3. âŒ VERIFICACIÃ“N DE ACCESO PREMATURA
   â€¢ verificarAcceso() se llamaba sin verificar sesiÃ³n primero
   â€¢ No habÃ­a validaciÃ³n de autenticaciÃ³n en index.php
   â€¢ Ahora valida sesiÃ³n en index.php ANTES de llamar controlador

SOLUCIONES IMPLEMENTADAS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âœ… 1. RUTAS AGREGADAS A Public/index.php
   
   LÃ­neas ~390-420:
   
   case ($route === '/factura/ver'):
       if (empty($_SESSION['user_id'])) {
           header('Location: ' . $baseUrl . '/index.php?r=/login');
           exit;
       }
       require_once __DIR__ . '/../App/Controllers/InvoiceController.php';
       $controller = new \App\Controllers\InvoiceController();
       $controller->view();
       break;

   case ($route === '/factura/descargar'):
       if (empty($_SESSION['user_id'])) {
           header('Location: ' . $baseUrl . '/index.php?r=/login');
           exit;
       }
       require_once __DIR__ . '/../App/Controllers/InvoiceController.php';
       $controller = new \App\Controllers\InvoiceController();
       $controller->download();
       break;

   case ($route === '/factura/reenviar'):
       if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
           header('Content-Type: application/json; charset=utf-8');
           echo json_encode(['success' => false, 'message' => 'MÃ©todo no permitido']);
           exit;
       }
       if (empty($_SESSION['user_id'])) {
           header('Content-Type: application/json; charset=utf-8');
           echo json_encode(['success' => false, 'message' => 'Acceso denegado']);
           exit;
       }
       require_once __DIR__ . '/../App/Controllers/InvoiceController.php';
       $controller = new \App\Controllers\InvoiceController();
       $controller->resend();
       break;

âœ… 2. InvoiceController REESCRITO
   
   â€¢ Ahora verifica $_SESSION['user_id'] al inicio de cada mÃ©todo
   â€¢ Usa $_SESSION['user_role'] (sin la 'u')
   â€¢ Redirige a login si no estÃ¡ autenticado
   â€¢ Usa Db::connect() directamente en lugar de Models
   â€¢ Llamadas SQL directas mÃ¡s robustas

âœ… 3. MÃ‰TODOS AÃ‘ADIDOS
   
   â€¢ obtenerPedido($id): Consulta directa a BD
   â€¢ obtenerDetallesPedido($id): Consulta directa a BD
   â€¢ verificarAcceso($id): Valida permisos del usuario

CÃ“MO PROBAR:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1ï¸âƒ£ LOGIN PRIMERO
   http://localhost/TIENDA_MOVICELL/Public/index.php?r=/login
   
   Usuario: cualquier usuario registrado
   ContraseÃ±a: su contraseÃ±a

2ï¸âƒ£ LUEGO ACCEDER A FACTURA
   http://localhost/TIENDA_MOVICELL/Public/index.php?r=/factura/ver&id=20
   (reemplaza 20 con un ID de pedido real del usuario logueado)

3ï¸âƒ£ O DESDE EL PANEL
   http://localhost/TIENDA_MOVICELL/Public/index.php?r=/panel
   â€¢ Ver botones en "Mis Pedidos"
   â€¢ Clickear "Ver PDF" o "â¬‡ï¸ PDF"

ERRORES COMUNES Y SOLUCIONES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âŒ "Error: Usuario no autenticado"
   â†’ SoluciÃ³n: Debes estar logueado primero
   â†’ Ve a /login antes

âŒ "Error: No tienes permiso para ver este pedido"
   â†’ SoluciÃ³n: El pedido no es tuyo
   â†’ Como usuario, solo ves tus pedidos
   â†’ Como admin, ves todos

âŒ "Error: ID de pedido no proporcionado"
   â†’ SoluciÃ³n: Falta el parÃ¡metro ?id=XX
   â†’ URL correcta: /factura/ver?id=20

âŒ Se redirige a inicio automÃ¡ticamente
   â†’ SoluciÃ³n: Las rutas no estaban en index.php (YA CORREGIDO)
   â†’ Limpia cache del navegador (Ctrl+Shift+Delete)
   â†’ Si sigue: comprueba que Public/index.php estÃ¡ actualizado

âŒ "Pedido no encontrado"
   â†’ SoluciÃ³n: El ID no existe en la BD
   â†’ Verifica que el pedido existe
   â†’ Comprueba que tiene el formato correcto

VERIFICACIÃ“N DE LA SOLUCIÃ“N:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Ejecuta:
  php tools/diagnostico_facturas.php

Debe mostrar:
  âœ“ Verificando archivos...
  âœ“ Verificando clases y mÃ©todos...
  âœ“ Verificando rutas en index.php...
  âœ“ Verificando variables de sesiÃ³n...
  âœ“ URLs para prueba...
  âœ… DIAGNÃ“STICO COMPLETADO

ARCHIVOS MODIFICADOS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Public/index.php
   â€¢ Agregadas 3 nuevas rutas (factura/ver, factura/descargar, factura/reenviar)
   â€¢ Cada ruta verifica autenticaciÃ³n antes de llamar controlador
   â€¢ Rutas agregadas ANTES del 'default' case

2. App/Controllers/InvoiceController.php
   â€¢ REESCRITO completamente
   â€¢ Ahora usa Db::connect() directamente
   â€¢ Verifica autenticaciÃ³n al inicio de cada mÃ©todo
   â€¢ Usa nombre correcto de variable de sesiÃ³n: user_role

3. tools/diagnostico_facturas.php
   â€¢ CREADO nuevo script para verificar configuraciÃ³n

RESUMENCITO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

El problema ERA que:
â€¢ Las rutas NO estaban en el router
â€¢ Las variables de sesiÃ³n estaban mal nombradas
â€¢ No habÃ­a verificaciÃ³n de autenticaciÃ³n previa

Ahora FUNCIONA porque:
â€¢ âœ… Rutas estÃ¡n en Public/index.php antes de default
â€¢ âœ… Variables de sesiÃ³n tienen nombres correctos
â€¢ âœ… index.php verifica autenticaciÃ³n antes de llamar controlador
â€¢ âœ… InvoiceController es mÃ¡s robusto

PASOS PARA VERIFICAR:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. â˜‘ï¸ Verifica que Public/index.php tiene las 3 nuevas rutas
2. â˜‘ï¸ Verifica que estÃ¡n ANTES de 'default' case
3. â˜‘ï¸ Verifica que App/Controllers/InvoiceController.php existe
4. â˜‘ï¸ Limpia cache del navegador
5. â˜‘ï¸ Login en tu cuenta
6. â˜‘ï¸ Ve a /panel
7. â˜‘ï¸ Clickea "Ver PDF" en un pedido
8. â˜‘ï¸ DeberÃ­a abrir factura en nueva pestaÃ±a âœ…

Si SIGUE SIN FUNCIONAR:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Verifica logs de PHP:
   tail -f C:\xampp\apache\logs\error.log

2. Verifica que el usuario estÃ¡ logueado:
   Abre navegador â†’ F12 â†’ Storage â†’ Cookies
   Busca sesiÃ³n PHP (PHPSESSID)

3. Prueba URL directa con ID conocido:
   /factura/ver?id=1

4. Si sigue error, revisa:
   â€¢ Â¿Tiene el usuario ese pedido?
   â€¢ Â¿El pedido existe en la BD?
   â€¢ Â¿Hay datos en detalle_pedidos?

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generado: 2025-12-05
Estado: âœ… CORREGIDO Y LISTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
